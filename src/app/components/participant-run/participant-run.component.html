<div class="container" (click)="registerUserInteraction()" (touchstart)="registerUserInteraction()">
  <!-- Compact Top Bar (top-left) - kluczowe statystyki + GPS indicator -->
  <div class="compact-top-bar" *ngIf="wasRunActivate && !isRunFinished">
    <span class="gps-indicator"
          [class.active]="gpsStatus === 'active'"
          [class.error]="gpsStatus === 'error'"
          [class.off]="gpsStatus === 'off'"
          [title]="getGpsStatusTitle()">
      <i class="pi pi-map-marker"></i>
    </span>
    <span class="compact-stat" title="Punkty kontrolne">
      <i class="pi pi-star"></i>
      {{checkpointsNumber}}
    </span>
    <span class="compact-stat" title="Czas biegu">
      <i class="pi pi-stopwatch"></i>
      {{raceTimeDisplay}}
    </span>
    <span class="compact-stat" title="Aktualny czas">
      <i class="pi pi-clock"></i>
      {{currentTime}}
    </span>
  </div>

  <!-- Hamburger Menu Button (top-right) - ukryty po zakończeniu biegu -->
  <button
    *ngIf="wasRunActivate && !isRunFinished"
    pButton
    pRipple
    type="button"
    icon="pi pi-bars"
    class="hamburger-menu-button p-button-rounded"
    title="Menu"
    (click)="toggleMenu()">
  </button>

  <!-- Przycisk zamknięcia podsumowania (top-right) - widoczny tylko po zakończeniu biegu -->
  <button
    *ngIf="isRunFinished"
    pButton
    pRipple
    type="button"
    icon="pi pi-times"
    class="close-summary-button p-button-rounded"
    title="Zakończ podsumowanie"
    (click)="onCloseSummary()">
  </button>

  <!-- Panel podsumowania po zakończeniu biegu - dwukolumnowy layout -->
  <div class="finish-summary-panel" 
       *ngIf="isRunFinished" 
       [class.expanded]="isSummaryExpanded" 
       [class.collapsed]="!isSummaryExpanded">
    
    <!-- Uchwyt do przeciągania (swipe indicator) -->
    <div class="swipe-handle" (click)="toggleSummaryPanel()"></div>

    <!-- Skrócony widok gdy zwinięte - wszystkie statystyki na środku -->
    <div class="summary-collapsed-view" *ngIf="!isSummaryExpanded" (click)="toggleSummaryPanel()">
      <span class="collapsed-stat">
        <i class="pi pi-stopwatch"></i>
        {{trackStats?.totalDuration || raceTimeDisplay}}
      </span>
      <span class="collapsed-stat">
        <i class="pi pi-map"></i>
        {{trackStats?.totalDistance || '--'}}
      </span>
      <span class="collapsed-stat">
        <i class="pi pi-gauge"></i>
        {{trackStats?.averageSpeed || '--'}}
      </span>
      <span class="collapsed-stat">
        <i class="pi pi-star"></i>
        {{checkpointsNumber}}
      </span>
    </div>

    <!-- Dwukolumnowy kontener - tylko gdy rozwinięte -->
    <div class="summary-columns" *ngIf="isSummaryExpanded">
      <!-- Lewa kolumna - statystyki -->
      <div class="stats-column">
        <div class="stat-item" title="Czas trasy">
          <i class="pi pi-stopwatch"></i>
          <span>{{trackStats?.totalDuration || raceTimeDisplay}}</span>
        </div>
        <div class="stat-item" title="Dystans">
          <i class="pi pi-map"></i>
          <span>{{trackStats?.totalDistance || '--'}}</span>
        </div>
        <div class="stat-item" title="Śr. prędkość">
          <i class="pi pi-gauge"></i>
          <span>{{trackStats?.averageSpeed || '--'}}</span>
        </div>
        <div class="stat-item" title="Punkty kontrolne">
          <i class="pi pi-star"></i>
          <span>{{checkpointsNumber}}</span>
        </div>
      </div>

      <!-- Prawa kolumna - przewijalna lista stanowisk -->
      <div class="stations-column">
        <div class="stations-header">
          <span>Stanowiska</span>
        </div>
        <div class="stations-list" *ngIf="scannedStations.length > 0" (click)="$event.stopPropagation()">
          <div class="station-item" *ngFor="let station of scannedStations">
            <span class="station-name">{{station.stationName}}</span>
            <span class="station-type">{{station.stationTypeLabel}}</span>
            <span class="station-time">{{station.scannedAt}}</span>
          </div>
        </div>
        <div class="stations-placeholder" *ngIf="scannedStations.length === 0">
          <i class="pi pi-info-circle"></i>
          <span>Brak danych</span>
        </div>
      </div>
    </div>
  </div>

  <participant-map
    #mapComponent
    [stationsToShow]="stationsToShow"
    [backgroundMapId]="backgroundMap?.id"
    [minZoom]="backgroundMap?.minZoom"
    [maxZoom]="backgroundMap?.maxZoom"
    [northEast]="backgroundMap?.northEast"
    [southWest]="backgroundMap?.southWest">
  </participant-map>

  <!-- Przyciski floating (QR + Tracking Mode) -->
  <div class="floating-buttons" *ngIf="!isRunFinished">
    <!-- Przycisk Tracking Mode - tylko po aktywacji biegu -->
    <button
      *ngIf="wasRunActivate"
      pButton
      pRipple
      type="button"
      icon="pi pi-moon"
      [class]="'tracking-mode-floating-button p-button-rounded' + (isInTrackingMode ? ' active' : '')"
      title="Tryb oszczędzania energii"
      (click)="toggleTrackingMode()">
    </button>

    <!-- Przycisk QR - zawsze widoczny przed zakończeniem -->
    <button
      pButton
      pRipple
      type="button"
      icon="pi pi-qrcode"
      class="qr-scanner-icon p-button-rounded"
      [class.scanning]="isScanning"
      [disabled]="isScanning"
      title="Skanuj kod QR"
      (click)="toggleScanner()">
    </button>
  </div>

  <qr-scanner
    *ngIf="showScanner"
    class="fullscreen-mode"
    (qrCodeScanned)="receiveScan($event)"
    (close)="toggleScanner()">
  </qr-scanner>

  <div *ngIf="isScanning" class="scanning-overlay">
    <div class="scanning-content">
      <p-progressSpinner styleClass="custom-spinner" strokeWidth="4"></p-progressSpinner>
      <h2>Przetwarzanie...</h2>
      <p>Zapisywanie punktu kontrolnego</p>
    </div>
  </div>

  <!-- Hamburger Menu Dialog - Opcja A: Sekcje + bezpośrednie kontrolki -->
  <p-dialog
    [(visible)]="showMenu"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    styleClass="hamburger-menu-dialog"
    header="Menu">
    <div class="menu-options">
      <!-- SEKCJA: MAPA -->
      <div class="menu-section">
        <span class="menu-section-title">Mapa</span>
        <button
          pButton
          pRipple
          type="button"
          icon="pi pi-home"
          label="Centruj mapę"
          class="menu-option-button"
          (click)="resetMapView(); showMenu = false">
        </button>
        <button
          pButton
          pRipple
          type="button"
          icon="pi pi-map-marker"
          label="Pokaż wszystkie stanowiska"
          class="menu-option-button"
          (click)="highlightStations(); showMenu = false">
        </button>
      </div>

      <!-- SEKCJA: OSZCZĘDZANIE ENERGII (tylko podczas aktywnego biegu) -->
      <div class="menu-section" *ngIf="!isRunFinished && wasRunActivate">
        <span class="menu-section-title">Ustawienia</span>
        
        <!-- GPS Mode - bezpośredni dropdown -->
        <div class="menu-setting-row">
          <div class="menu-setting-label">
            <i class="pi pi-chart-line"></i>
            <span>Zapis trasy</span>
          </div>
          <p-dropdown
            [(ngModel)]="currentGpsMode"
            [options]="[
              {label: 'Auto', value: TrackingMode.AUTO},
              {label: 'Dokładny', value: TrackingMode.HIGH},
              {label: 'Zbalansowany', value: TrackingMode.MEDIUM},
              {label: 'Oszczędny', value: TrackingMode.LOW},
              {label: 'Wyłączony', value: TrackingMode.OFF}
            ]"
            optionLabel="label"
            optionValue="value"
            (onChange)="onGpsModeChange($event.value)"
            appendTo="body"
            styleClass="menu-dropdown">
          </p-dropdown>
        </div>

        <!-- Auto-wygaszanie - bezpośredni dropdown -->
        <div class="menu-setting-row">
          <div class="menu-setting-label">
            <i class="pi pi-moon"></i>
            <span>Auto-wygaszanie</span>
          </div>
          <p-dropdown
            [(ngModel)]="autoTrackingModeDelay"
            [options]="[
              {label: 'Wyłączone', value: 0},
              {label: '30s', value: 30},
              {label: '1 min', value: 60},
              {label: '2 min', value: 120},
              {label: '5 min', value: 300}
            ]"
            optionLabel="label"
            optionValue="value"
            (onChange)="onAutoWygaszanieChange($event.value)"
            appendTo="body"
            styleClass="menu-dropdown">
          </p-dropdown>
        </div>

        <!-- Ostrzeżenie jeśli GPS wyłączony -->
        <div class="menu-warning" *ngIf="currentGpsMode === TrackingMode.OFF">
          <i class="pi pi-exclamation-triangle"></i>
          <span>GPS wyłączony - trasa nie będzie zapisana</span>
        </div>
      </div>

      <!-- Info o zakończonym biegu -->
      <div *ngIf="isRunFinished" class="gps-tracking-finished-info">
        <i class="pi pi-check-circle"></i>
        <span>Bieg zakończony</span>
      </div>
    </div>
  </p-dialog>

  <!-- GPS Settings Dialog -->
  <p-dialog
    [(visible)]="showGpsSettings"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    styleClass="gps-settings-dialog"
    header="Ustawienia GPS Tracking">
    <div class="gps-mode-selector">
      <div
        *ngFor="let mode of [TrackingMode.HIGH, TrackingMode.MEDIUM, TrackingMode.LOW, TrackingMode.OFF]"
        class="gps-mode-option"
        [class.selected]="currentGpsMode === mode"
        (click)="onGpsModeChange(mode)">
        <div class="gps-mode-radio"></div>
        <div class="gps-mode-info">
          <span class="gps-mode-label">{{ getModeLabel(mode) }}</span>
          <span class="gps-mode-description">{{ getModeDescription(mode) }}</span>
        </div>
      </div>
    </div>

    <div class="gps-status-info">
      <div class="gps-status-item">
        <span class="gps-status-label">Status:</span>
        <span class="gps-status-value">{{ gpsTrackingEnabled ? 'Aktywny' : 'Nieaktywny' }}</span>
      </div>
      <div class="gps-status-item">
        <span class="gps-status-label">Tryb:</span>
        <span class="gps-status-value">{{ getModeLabel(currentGpsMode) }}</span>
      </div>
    </div>

    <div class="gps-auto-adjust">
      <span class="gps-auto-adjust-label">Auto-dostosowanie przy niskiej baterii</span>
      <p-inputSwitch [(ngModel)]="autoAdjustEnabled" (onChange)="onAutoAdjustChange()"></p-inputSwitch>
    </div>

    <div class="gps-warning" *ngIf="currentGpsMode === TrackingMode.OFF">
      <i class="pi pi-exclamation-triangle"></i>
      Wyłączenie trackingu GPS uniemożliwi wyświetlenie szczegółowej trasy po zakończeniu biegu.
    </div>
  </p-dialog>

  <!-- Tracking Mode Component (Power Saving Black Screen) -->
  <app-tracking-mode
    *ngIf="isInTrackingMode"
    [batteryLevel]="batteryLevel"
    [gpsTrackingEnabled]="gpsTrackingEnabled"
    [gpsStatus]="gpsStatus"
    (exitTrackingMode)="exitTrackingMode()">
  </app-tracking-mode>

  <!-- Tracking Mode Info Dialog (First Time) -->
  <p-dialog
    [(visible)]="showTrackingModeInfo"
    [modal]="true"
    [closable]="false"
    [dismissableMask]="false"
    styleClass="tracking-mode-info-dialog"
    header="Tryb Oszczędzania Energii">
    <div class="tracking-mode-info-content">
      <!-- Preview of dark mode -->
      <p class="preview-label">Podgląd ekranu:</p>
      <div class="tracking-mode-preview">
        <span class="preview-gps-indicator">
          <i class="pi pi-map-marker"></i>
        </span>
        <span class="preview-battery">
          <i class="pi pi-bolt"></i> 85%
        </span>
        <span class="preview-time">14:30</span>
      </div>

      <div class="info-features">
        <div class="info-feature">
          <i class="pi pi-map-marker"></i>
          <span>GPS nadal śledzi trasę</span>
        </div>
      </div>

      <div class="info-hint">
        <i class="pi pi-cog"></i>
        <span>Czas automatycznego włączania możesz zmienić w menu <i class="pi pi-bars"></i></span>
      </div>

      <div class="info-actions">
        <button
          pButton
          pRipple
          type="button"
          label="Włącz tryb"
          class="p-button-success"
          (click)="confirmTrackingModeInfo()">
        </button>
        <span class="info-cancel-link" (click)="showTrackingModeInfo = false">Anuluj</span>
      </div>
    </div>
  </p-dialog>

  <!-- Confirm Dialog dla zamknięcia podsumowania -->
  <p-confirmDialog 
    key="finishConfirm"
    styleClass="finish-confirm-dialog"
    [closable]="false"
    [style]="{width: '90vw', maxWidth: '400px'}">
  </p-confirmDialog>
</div>
