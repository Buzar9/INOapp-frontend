<div class="container" (click)="registerUserInteraction()" (touchstart)="registerUserInteraction()">
  <!-- Hamburger Menu Button (top-left) -->
  <button
    *ngIf="wasRunActivate"
    pButton
    pRipple
    type="button"
    icon="pi pi-bars"
    class="hamburger-menu-button p-button-rounded"
    title="Menu"
    (click)="toggleMenu()">
  </button>

  <!-- Compact Top Bar (top-right) - tylko kluczowe statystyki -->
  <div class="compact-top-bar" *ngIf="wasRunActivate && !isRunFinished">
    <span class="compact-stat" title="Punkty kontrolne">
      <i class="pi pi-star"></i>
      {{checkpointsNumber}}
    </span>
    <span class="compact-stat" title="Czas biegu">
      <i class="pi pi-stopwatch"></i>
      {{raceTimeDisplay}}
    </span>
    <span class="compact-stat" title="Aktualny czas">
      <i class="pi pi-clock"></i>
      {{currentTime}}
    </span>
  </div>

  <!-- Finish Top Bar (po zakończeniu biegu) -->
  <div class="finish-top-bar" *ngIf="wasRunActivate && isRunFinished">
    <span class="compact-stat" title="Punkty kontrolne">
      <i class="pi pi-star"></i>
      {{checkpointsNumber}}
    </span>
    <span class="compact-stat" title="Czas biegu">
      <i class="pi pi-stopwatch"></i>
      {{raceTimeDisplay}}
    </span>
    <button
      pButton
      pRipple
      type="button"
      icon="pi pi-sign-out"
      class="p-button-rounded p-button-danger"
      title="Nowa trasa"
      (click)="onNewRoute()">
    </button>
  </div>

  <participant-map
    #mapComponent
    [stationsToShow]="stationsToShow"
    [backgroundMapId]="backgroundMap?.id"
    [minZoom]="backgroundMap?.minZoom"
    [maxZoom]="backgroundMap?.maxZoom"
    [northEast]="backgroundMap?.northEast"
    [southWest]="backgroundMap?.southWest">
  </participant-map>

  <!-- Przyciski floating (QR + Tracking Mode) -->
  <div class="floating-buttons" *ngIf="!isRunFinished">
    <!-- Przycisk Tracking Mode - tylko po aktywacji biegu -->
    <button
      *ngIf="wasRunActivate"
      pButton
      pRipple
      type="button"
      icon="pi pi-moon"
      [class]="'tracking-mode-floating-button p-button-rounded' + (isInTrackingMode ? ' active' : '')"
      title="Tryb oszczędzania energii"
      (click)="toggleTrackingMode()">
    </button>

    <!-- Przycisk QR - zawsze widoczny przed zakończeniem -->
    <button
      pButton
      pRipple
      type="button"
      icon="pi pi-qrcode"
      class="qr-scanner-icon p-button-rounded"
      [class.scanning]="isScanning"
      [disabled]="isScanning"
      title="Skanuj kod QR"
      (click)="toggleScanner()">
    </button>
  </div>

  <qr-scanner
    *ngIf="showScanner"
    class="fullscreen-mode"
    (qrCodeScanned)="receiveScan($event)"
    (close)="toggleScanner()">
  </qr-scanner>

  <div *ngIf="isScanning" class="scanning-overlay">
    <div class="scanning-content">
      <p-progressSpinner styleClass="custom-spinner" strokeWidth="4"></p-progressSpinner>
      <h2>Przetwarzanie...</h2>
      <p>Zapisywanie punktu kontrolnego</p>
    </div>
  </div>

  <!-- Hamburger Menu Dialog -->
  <p-dialog
    [(visible)]="showMenu"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    styleClass="hamburger-menu-dialog"
    header="Menu">
    <div class="menu-options">
      <button
        pButton
        pRipple
        type="button"
        icon="pi pi-home"
        label="Centruj mapę"
        class="menu-option-button"
        (click)="resetMapView(); showMenu = false">
      </button>
      <button
        pButton
        pRipple
        type="button"
        icon="pi pi-eye"
        label="Pokaż stanowiska"
        class="menu-option-button"
        (click)="highlightStations(); showMenu = false">
      </button>
      <!-- Opcja ustawień GPS - dostępna tylko podczas aktywnego biegu -->
      <button
        *ngIf="!isRunFinished"
        pButton
        pRipple
        type="button"
        icon="pi pi-map-marker"
        label="Ustawienia śledzenia trasy"
        [class]="'menu-option-button' + (gpsTrackingEnabled ? ' tracking-active' : '')"
        (click)="toggleGpsSettings()">
      </button>
      <!-- Informacja o zakończonym śledzeniu trasy - widoczna po zakończeniu biegu -->
      <div *ngIf="isRunFinished" class="gps-tracking-finished-info">
        <i class="pi pi-check-circle"></i>
        <span>Śledzenie trasy zakończone</span>
      </div>

      <!-- Auto Screen Dimming Settings - dostępne podczas aktywnego biegu -->
      <div *ngIf="!isRunFinished && wasRunActivate" class="auto-dimming-section">
        <div class="auto-dimming-header">
          <span class="auto-dimming-label">Auto-wyciemnienie ekranu</span>
          <p-inputSwitch [(ngModel)]="autoTrackingModeEnabled" (onChange)="toggleAutoTrackingMode()"></p-inputSwitch>
        </div>
        <div *ngIf="autoTrackingModeEnabled" class="auto-dimming-delay">
          <span class="delay-label">Opóźnienie:</span>
          <p-dropdown
            [(ngModel)]="autoTrackingModeDelay"
            [options]="[
              {label: '30 sekund', value: 30},
              {label: '1 minuta', value: 60},
              {label: '2 minuty', value: 120},
              {label: '5 minut', value: 300}
            ]"
            optionLabel="label"
            optionValue="value"
            (onChange)="changeAutoTrackingDelay(autoTrackingModeDelay)"
            styleClass="delay-dropdown">
          </p-dropdown>
        </div>
        <div *ngIf="autoTrackingModeEnabled" class="auto-dimming-info">
          <i class="pi pi-info-circle"></i>
          <span>Czarny ekran włączy się automatycznie po braku aktywności</span>
        </div>
      </div>

      <div class="menu-info">
        <div class="menu-info-item">
          <i class="pi pi-clock"></i>
          <span>{{currentTime}}</span>
        </div>
        <div class="menu-info-item" *ngIf="batteryLevel < 100">
          <i class="pi pi-bolt"></i>
          <span>{{batteryLevel}}%</span>
        </div>
      </div>
    </div>
  </p-dialog>

  <!-- GPS Settings Dialog -->
  <p-dialog
    [(visible)]="showGpsSettings"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    styleClass="gps-settings-dialog"
    header="Ustawienia GPS Tracking">
    <div class="gps-mode-selector">
      <div
        *ngFor="let mode of [TrackingMode.HIGH, TrackingMode.MEDIUM, TrackingMode.LOW, TrackingMode.OFF]"
        class="gps-mode-option"
        [class.selected]="currentGpsMode === mode"
        (click)="onGpsModeChange(mode)">
        <div class="gps-mode-radio"></div>
        <div class="gps-mode-info">
          <span class="gps-mode-label">{{ getModeLabel(mode) }}</span>
          <span class="gps-mode-description">{{ getModeDescription(mode) }}</span>
        </div>
      </div>
    </div>

    <div class="gps-status-info">
      <div class="gps-status-item">
        <span class="gps-status-label">Status:</span>
        <span class="gps-status-value">{{ gpsTrackingEnabled ? 'Aktywny' : 'Nieaktywny' }}</span>
      </div>
      <div class="gps-status-item">
        <span class="gps-status-label">Tryb:</span>
        <span class="gps-status-value">{{ getModeLabel(currentGpsMode) }}</span>
      </div>
    </div>

    <div class="gps-auto-adjust">
      <span class="gps-auto-adjust-label">Auto-dostosowanie przy niskiej baterii</span>
      <p-inputSwitch [(ngModel)]="autoAdjustEnabled" (onChange)="onAutoAdjustChange()"></p-inputSwitch>
    </div>

    <div class="gps-warning" *ngIf="currentGpsMode === TrackingMode.OFF">
      <i class="pi pi-exclamation-triangle"></i>
      Wyłączenie trackingu GPS uniemożliwi wyświetlenie szczegółowej trasy po zakończeniu biegu.
    </div>
  </p-dialog>

  <!-- Tracking Mode Component (Power Saving Black Screen) -->
  <app-tracking-mode
    *ngIf="isInTrackingMode"
    [batteryLevel]="batteryLevel"
    (exitTrackingMode)="exitTrackingMode()">
  </app-tracking-mode>

  <!-- Tracking Mode Info Dialog (First Time) -->
  <p-dialog
    [(visible)]="showTrackingModeInfo"
    [modal]="true"
    [closable]="false"
    [dismissableMask]="false"
    styleClass="tracking-mode-info-dialog"
    header="Tryb Oszczędzania Energii">
    <div class="tracking-mode-info-content">
      <p class="info-title">Czarny ekran oszczędza baterię podczas biegu</p>

      <div class="info-features">
        <div class="info-feature">
          <i class="pi pi-moon"></i>
          <span>Ekran pozostanie włączony, ale czarny</span>
        </div>
        <div class="info-feature">
          <i class="pi pi-map-marker"></i>
          <span>GPS nadal śledzi Twoją trasę</span>
        </div>
      </div>

      <!-- Auto Screen Dimming Settings in First-Time Dialog -->
      <div class="info-auto-dimming-section">
        <div class="info-auto-dimming-header">
          <span class="info-auto-dimming-label">Auto-wyciemnienie po braku aktywności</span>
          <p-inputSwitch [(ngModel)]="dialogAutoTrackingEnabled" (onChange)="onDialogAutoTrackingChange()"></p-inputSwitch>
        </div>
        <div *ngIf="dialogAutoTrackingEnabled" class="info-auto-dimming-delay">
          <span class="delay-label">Opóźnienie:</span>
          <p-dropdown
            [(ngModel)]="dialogAutoTrackingDelay"
            [options]="[
              {label: '30 sekund', value: 30},
              {label: '1 minuta', value: 60},
              {label: '2 minuty', value: 120},
              {label: '5 minut', value: 300}
            ]"
            optionLabel="label"
            optionValue="value"
            styleClass="delay-dropdown">
          </p-dropdown>
        </div>
      </div>

      <div class="info-actions">
        <button
          pButton
          pRipple
          type="button"
          label="Rozumiem, włącz tryb"
          class="p-button-success"
          (click)="confirmTrackingModeInfo()">
        </button>
        <button
          pButton
          pRipple
          type="button"
          label="Anuluj"
          class="p-button-secondary"
          (click)="showTrackingModeInfo = false">
        </button>
      </div>
    </div>
  </p-dialog>
</div>
